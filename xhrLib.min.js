// ==UserScript==
// ==UserLibrary==
// @name         xhrLib
// @namespace    https://openuserjs.org/users/Anakunda
// @copyright    2021, Anakunda (https://openuserjs.org/users/Anakunda)
// @license      GPL-3.0-or-later
// @version      1.23.1
// @author       Anakunda
// @exclude      *
// ==/UserScript==
// ==/UserLibrary==
'use strict';var domParser=new DOMParser,xhrLibmaxRetries='function'==typeof GM_getValue?GM_getValue('xhr_max_retries',100):100;const unstableHttpErrors=[500,502,504];let isBrokenTM;try{isBrokenTM='Tampermonkey'==GM_info.scriptHandler&&/^(?:4\.12)\b/.test(GM_info.version)}catch(e){isBrokenTM=!1}function localXHR(url,params,data){return url?new Promise((function(resolve,reject){function getParam(key){if(key&&params&&'object'==typeof params)return key=key.toLowerCase(),(key=Object.keys(params).find(_key=>_key.toLowerCase()==key))&&params[key]}function reSend(){xhr.open(method,url,!0),xhr.send(data)}const xhr=new XMLHttpRequest;let method=(getParam('method')||'GET').toUpperCase(),noResponse=!1,retryCounter=0;data&&(method='POST'),xhr.open(method,url,!0),xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');const responseType=getParam('responseType');if('HEAD'!=method)switch(responseType){case null:noResponse=!0;break;case void 0:xhr.responseType='document';break;default:responseType&&(xhr.responseType=responseType)}switch(xhr.responseType){case'document':xhr.setRequestHeader('Accept','text/html');break;case'xml':xhr.setRequestHeader('Accept','text/xml');break;case'json':xhr.setRequestHeader('Accept','application/json');break;default:xhr.setRequestHeader('Accept','*/*')}void 0===data&&(data=getParam('body')),void 0!==data&&('string'==typeof data?xhr.setRequestHeader('Content-Type','text/plain; charset=UTF-8'):data instanceof FormData||(data instanceof URLSearchParams?xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded; charset=utf-8'):data instanceof ArrayBuffer||data&&'object'==typeof data&&(xhr.setRequestHeader('Content-Type','application/json; charset=UTF-8'),data=JSON.stringify(data))));const headers=getParam('headers');'object'==typeof headers&&Object.keys(headers).forEach(key=>{xhr.setRequestHeader(key,headers[key])}),'HEAD'==method?xhr.onreadystatechange=function(){this.readyState<XMLHttpRequest.HEADERS_RECEIVED||(0==this.status||this.status>=200&&this.status<400?resolve(this):unstableHttpErrors.includes(this.status)&&xhrLibmaxRetries>0&&++retryCounter<=xhrLibmaxRetries?(defaultErrorHandler(this),reSend()):reject(defaultErrorHandler(this)))}:noResponse?xhr.onreadystatechange=function(){this.readyState<XMLHttpRequest.DONE||(/*this.status == 0 || */this.status>=200&&this.status<400?resolve(this.status):unstableHttpErrors.includes(this.status)&&xhrLibmaxRetries>0&&++retryCounter<=xhrLibmaxRetries?(defaultErrorHandler(this),reSend()):reject(defaultErrorHandler(this)))}:xhr.onload=function(){/*this.status == 0 || */this.status>=200&&this.status<400?resolve(this.response):unstableHttpErrors.includes(this.status)&&xhrLibmaxRetries>0&&++retryCounter<=xhrLibmaxRetries?(defaultErrorHandler(this),reSend()):reject(defaultErrorHandler(this))},xhr.onerror=function(){unstableHttpErrors.includes(this.status)&&xhrLibmaxRetries>0&&++retryCounter<=xhrLibmaxRetries?(defaultErrorHandler(this),reSend()):reject(defaultErrorHandler(this))},xhr.ontimeout=function(){xhrLibmaxRetries>0&&++retryCounter<=xhrLibmaxRetries?(defaultTimeoutHandler(this),reSend()):reject(defaultTimeoutHandler(this))},
//xhr.timeout = 60000;
//console.debug('XMLHttpRequest.send(...):', xhr);
xhr.send(data)})):Promise.reject(new Error('URL missing'))}function globalXHR(url,params,data){return url?new Promise((function(resolve,reject){function addFunc(response){response.getHeaderValue=function(key){if(!key||'string'!=typeof key)return;let entries=this.responseHeaders.split(/\r?\n/).map(line=>/^(\S+)\s*:\s*(.*)$/.test(line)?[RegExp.$1.toLowerCase(),RegExp.$2]:null).filter(Array.isArray);return new Map(entries).get(key.toLowerCase())}}const localParams=Object.assign({url:url,method:data?'POST':'GET',headers:{}},params);let retryCounter=0;if('HEAD'!=localParams.method.toUpperCase()&&void 0===localParams.responseType&&(localParams.responseType='document'),'object'!=typeof localParams.headers&&(localParams.headers={}),!localParams.headers.Accept)switch(localParams.responseType?localParams.responseType.toLowerCase():void 0){case'document':case'text/html':case'html':localParams.headers.Accept='text/html';break;case'xml':case'text/xml':localParams.headers.Accept='text/xml';break;case'json':case'application/json':localParams.headers.Accept='application/json';break;default:localParams.headers.Accept='*/*'}if(isBrokenTM&&localParams.responseType&&'document'==localParams.responseType.toLowerCase()&&(localParams.responseType='text/html'),localParams.fetch||(localParams.headers['X-Requested-With']='XMLHttpRequest'),'HEAD'==localParams.method?(localParams.onreadystatechange=function(response){response.readyState<XMLHttpRequest.HEADERS_RECEIVED||(response.status>=200&&response.status<400?(addFunc(response),resolve(response)):unstableHttpErrors.includes(response.status)&&xhrLibmaxRetries>0&&++retryCounter<=xhrLibmaxRetries?(defaultErrorHandler(response),hXHR=GM_xmlhttpRequest(localParams)):reject(defaultErrorHandler(response)),hXHR.abort())},delete localParams.responseType):localParams.onload=function(response){if(unstableHttpErrors.includes(response.status)&&xhrLibmaxRetries>0&&++retryCounter<=xhrLibmaxRetries)return defaultErrorHandler(response),void(hXHR=GM_xmlhttpRequest(localParams));if((response.status<200||response.status>=400)&&(response.finalUrl||0!=response.status)){if(localParams.responseType&&'json'==localParams.responseType.toLowerCase())try{return void reject(`HTTP error ${response.status}: response code ${response.response.error.code} (${response.response.error.message})`)}catch(e){}return reject(defaultErrorHandler(response))}if(localParams.responseType)switch(localParams.responseType.toLowerCase()){case'document':case'text/html':case'html':if(response.response instanceof HTMLDocument)response.document=response.response;else if(response.responseText)try{response.document=domParser.parseFromString(response.responseText,'text/html')}catch(e){console.warn('globalXHR(...) response not valid HTML:',response.responseText,e),response.document=null}break;case'application/json':case'json':if('object'==typeof response.response)response.json=response.response;else if(response.responseText)try{response.json=JSON.parse(response.responseText)}catch(e){console.warn('globalXHR(...) response not valid JSON:',response.responseText,e),response.json=null}break;case'text/xml':case'xml':if(response.response instanceof XMLDocument)response.xml=response.response;else if(response.responseText)try{response.xml=domParser.parseFromString(response.responseText,'text/xml')}catch(e){console.warn('globalXHR(...) response not valid XML:',response.responseText,e),response.xml=null}}addFunc(response),resolve(response)},localParams.onerror=function(response){unstableHttpErrors.includes(response.status)&&xhrLibmaxRetries>0&&++retryCounter<=xhrLibmaxRetries?(defaultErrorHandler(response),hXHR=GM_xmlhttpRequest(localParams)):reject(defaultErrorHandler(response))},localParams.ontimeout=function(response){xhrLibmaxRetries>0&&++retryCounter<=xhrLibmaxRetries?(defaultTimeoutHandler(response),hXHR=GM_xmlhttpRequest(localParams)):reject(defaultTimeoutHandler(response))},void 0===data&&(data=localParams.body),void 0!==data)if('string'==typeof data)localParams.headers['Content-Type']||(localParams.headers['Content-Type']='text/plain; charset=UTF-8'),
//localParams.headers['Content-Length'] = data.length;
localParams.data=data;else if(data instanceof FormData)
//if (!localParams.headers['Content-Type']) xhr.setRequestHeader('Content-Type', 'multipart/form-data; charset=utf-8');
//xhr.setRequestHeader('Content-Length', ???);
localParams.data=data;else if(data instanceof URLSearchParams)localParams.headers['Content-Type']||(localParams.headers['Content-Type']='application/x-www-form-urlencoded; charset=utf-8'),
//localParams.headers['Content-Length'] = data.toString().length;
localParams.data=data.toString();else if(data instanceof ArrayBuffer)
//if (!localParams.headers['Content-Type']) localParams.headers['Content-Type'] = 'application/arraybuffer';
//localParams.headers['Content-Length'] = data.byteLength;
localParams.data=data;else if(data instanceof Blob)localParams.data=data;else if(data&&'object'==typeof data){localParams.headers['Content-Type']||(localParams.headers['Content-Type']='application/json; charset=UTF-8');let json=JSON.stringify(data);
//localParams.headers['Content-Length'] = json.length;
localParams.data=json}else localParams.data=data;'body'in localParams&&delete localParams.body;
//console.debug('GM_xmlhttpRequest(...):', localParams);
var hXHR=GM_xmlhttpRequest(localParams)})):Promise.reject('URL missing')}function fileReader(filePath,params){return globalXHR(new URL('file:'+filePath),params)}function textFileReader(filePath,params){return fileReader(filePath,Object.assign(params||{},{responseType:'text'})).then(response=>response.responseText)}function defaultErrorHandler(response){console.error('HTTP error:',response);let e='HTTP error '+response.status;return response.statusText&&(e+=' ('+response.statusText+')'),response.error&&(e+=' ('+response.error+')'),e}function defaultTimeoutHandler(response){console.error('HTTP timeout:',response);return'HTTP timeout'}